<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>GeigerLink</title>

<link rel="icon" href='data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20100%20100%22%3E%0A%20%20%3Ccircle%20cx%3D%2250%22%20cy%3D%2250%22%20r%3D%2247%22%20fill%3D%22%23ffff00%22%20stroke%3D%22%23000000%22%20stroke-width%3D%227%22%2F%3E%0A%20%20%3Ccircle%20cx%3D%2250%22%20cy%3D%2250%22%20r%3D%228%22%20fill%3D%22black%22%2F%3E%0A%20%20%3Cpath%20d%3D%22M50%2050%20L50%2010%20A40%2040%200%200%201%2084.64101615137756%2030.000000000000004%20Z%22%20fill%3D%22black%22%20transform%3D%22rotate(0%2050%2050)%22%2F%3E%0A%20%20%3Cpath%20d%3D%22M50%2050%20L50%2010%20A40%2040%200%200%201%2084.64101615137756%2030.000000000000004%20Z%22%20fill%3D%22black%22%20transform%3D%22rotate(120%2050%2050)%22%2F%3E%0A%20%20%3Cpath%20d%3D%22M50%2050%20L50%2010%20A40%2040%200%200%201%2084.64101615137756%2030.000000000000004%20Z%22%20fill%3D%22black%22%20transform%3D%22rotate(240%2050%2050)%22%2F%3E%0A%3C%2Fsvg%3E' />


<style>
body {
  font-family: Helvetica, Arial, sans-serif;
  background:#eef2f8;
  margin:0; padding:20px;
  color:#0d1117;
}
.row { display:flex; gap:20px; width:100%; margin-bottom:20px; }
.col { flex:1; display:flex; flex-direction:column; }
.card {
  background:white;
  padding:18px;
  border-radius:14px;
  box-shadow:0 3px 10px rgba(0,0,0,0.15);
}
.equal-card {
  height:360px;
  display:flex;
  flex-direction:column;
}
table { width:100%; border-collapse:collapse; font-size:17px; }
th { background:#f2f4f8; font-weight:600; }
td, th { padding:8px; border-bottom:1px solid #e3e3e3; }

/* Live table: labels left, values right */
.live-table td:first-child { text-align:left; }
.live-table td:last-child  { text-align:right; font-family:"Courier New", monospace; }

/* Log table: number alignment stable */
.log-table th, .log-table td { text-align:right; font-family:"Courier New", monospace; }

button {
  font-size:16px; padding:8px 14px;
  border:none; border-radius:8px;
  background:#2563eb; color:white; cursor:pointer;
  margin:4px;
}
button:hover { background:#1e40af; }

.scroll-box {
  max-height:350px;
  overflow-y:auto;
  border:1px solid #d0d0d0;
  border-radius:8px;
  margin-top:10px;
}

.range-bar {
  height:40px; width:100%; background:#ccc; border-radius:6px; overflow:hidden;
}
.fill {
  height:100%; width:0%; background:green;
  transition:width .25s, background-color .25s;
}
\.histogram-container {
  display:flex;
  gap:20px;
  width:100vw;
  position:relative;
  left:50%;
  margin-left:-50vw;
  margin-top:20px;
}
.histogram-container {
  display:flex;
  flex-direction:row;
  gap:20px;
  width:100%;
  margin-top:20px;
}

/* half height (180px instead of 360px) */
.hist-card {
  flex:1;
  background:white;
  padding:18px;
  border-radius:14px;
  box-shadow:0 3px 10px rgba(0,0,0,0.15);
  height:180px;
  display:flex;
  flex-direction:column;
  justify-content:flex-start;
}

/* Chart canvas (same height as bar) */
#cpsCanvas {
  width:100%;
  height:100%;
  background:white;
  border:1px solid #ccc;
  border-radius:8px;
  display:block;
}

</style>
</head>

<body>
<div class="row">

  <!-- Controls -->
  <div class="col">
    <div class="card equal-card">
      <h3>GeigerLink Controls</h3>
      <button id="connectBtn">Connect</button>
      <button id="startBtn">Start</button>
      <button id="stopBtn">Stop</button>
      <button id="exportBtn">Export Data</button><br>
      <button id="soundToggleBtn">Sound: OFF</button>
    </div>
  </div>

  <!-- Live Data -->
  <div class="col">
    <div class="card equal-card">
      <h3>Live Data</h3>
      <table class="live-table">
        <tr><td><b>ADC</b></td><td id="live_adc">0</td></tr>
        <tr><td><b>Total Counts</b></td><td id="live_total">0</td></tr>
        <tr><td><b>CPS</b></td><td id="live_rate">0.0</td></tr>
        <tr><td><b>CPM</b></td><td id="live_cpm">0</td></tr>
        <tr><td><b>ÂµSv/h</b></td><td id="live_usvh">0.000</td></tr>
        <tr><td><b>mrem/h</b></td><td id="live_mremh">0.000</td></tr>
      </table>
    </div>
  </div>

  <!-- Logging -->
  <div class="col">
    <div class="card equal-card">
      <h3>Logging</h3>
      <div class="scroll-box">
        <table class="log-table">
          <thead>
            <tr><th>Time</th><th>CPS</th><th>Total</th></tr>
          </thead>
          <tbody id="pulseTable"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Dose Bar + Histogram side-by-side -->
<div class="histogram-container">

  <!-- Radiation Level -->
  <div class="hist-card">
    <h3>Radiation Level</h3>
    <div class="range-bar"><div id="bar" class="fill"></div></div>
    <div id="contextText" style="font-size:18px; margin-top:8px; font-weight:600;">
      Radiation level equal to: Normal Background
    </div>
  </div>

  <!-- CPS Histogram -->
  <div class="hist-card">
    <canvas id="cpsCanvas"></canvas>
  </div>

</div>

<script>
let port, reader, writer;
let decoder = new TextDecoderStream();
let running = false;
let startTime = 0;
let totalCounts = 0;
let intervalCounts = 0;
let cpsHistory = new Array(120).fill(0); // 120 seconds of CPS

const uSvPerCPM = 0.0057;

/* rolling windows */
let cpsWindow = [];
let doseWindow = [];
const windowSize = 30; // last 10 seconds smoothing

/* thresholds */
const thresholds = [
{level:0.01, name:"Deep Underground Lab"},
{level:0.05, name:"Normal Background"},
{level:0.15, name:"NZ Background (typical)"},
{level:1, name:"High-background region"},
{level:3, name:"Commercial Flight"},
{level:6, name:"High-altitude city"},
{level:8, name:"Polar aviation route"},
{level:12, name:"Dental X-ray (hour)"},
{level:20, name:"Fukushima Perimeter"},
{level:30, name:"Radon Hotspot (UK)"},
{level:50, name:"Ramsar, Iran"},
{level:100, name:"Fukushima Worker Gate"}
];
function classify(u){
 for(let t of thresholds) if(u <= t.level) return t.name;
 return thresholds.at(-1).name;
}

/* Geiger click */
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
let clickEnabled = false;
function geigerClick(){
 if(!clickEnabled) return;
 const osc = audioCtx.createOscillator();
 const gain = audioCtx.createGain();
 osc.type = "square";
 osc.frequency.value = 4500;
 gain.gain.value = 0.10;
 osc.connect(gain);
 gain.connect(audioCtx.destination);
 osc.start();
 osc.stop(audioCtx.currentTime + 0.002);
}
document.getElementById("soundToggleBtn").onclick=()=>{
 clickEnabled = !clickEnabled;
 audioCtx.resume();
 document.getElementById("soundToggleBtn").textContent =
   clickEnabled ? "Sound: ON" : "Sound: OFF";
};

async function readLoop(){
  try {
    while (true) {
      const {value, done} = await reader.read();

      if (done) {
        console.warn("Serial stream closed");
        break;
      }

      if (!value) continue;
      const x = parseInt(value.trim());

      if (!isNaN(x) && running) {
        totalCounts++;
        intervalCounts++;
        geigerClick();
        document.getElementById("live_adc").textContent = x;
        document.getElementById("live_total").textContent = totalCounts;
      }
    }
  } catch (err) {
    console.error("Serial read error:", err);
  }

  // COM port disconnected or closed
  running = false; // stop logging
  document.getElementById("live_adc").textContent = "--";
  document.getElementById("contextText").textContent =
    "Radiation level equal to: **NO SERIAL CONNECTION**";

  alert("Serial connection lost. Logging stopped.");
}

/* Connect */
document.getElementById("connectBtn").onclick = async () => {
  try {
    port = await navigator.serial.requestPort();
    await port.open({ baudRate:115200 });

    port.readable.pipeTo(decoder.writable);
    reader = decoder.readable.getReader();
    writer = port.writable.getWriter();

    // detect unexpected disconnect
    port.addEventListener("disconnect", () => {
      running = false;
      alert("Serial device disconnected.");
    });

    readLoop();
  } catch (err) {
    alert("Failed to open serial port.");
    console.error(err);
  }
};


/* Start */
document.getElementById("startBtn").onclick=()=>{
 running = true;
 totalCounts=0;
 intervalCounts=0;
 cpsWindow=[];
 doseWindow=[];
 startTime = performance.now();
 document.getElementById("pulseTable").innerHTML="";
};

/* Stop */
document.getElementById("stopBtn").onclick=()=> running=false;

/* Update each second */
setInterval(()=>{
 if(!running) return;

 const elapsed = Math.floor((performance.now()-startTime)/1000);
 const cps = intervalCounts;
 const cpm = cps * 60;
 const u = cpm * uSvPerCPM;

 cpsWindow.push(cps);
 if(cpsWindow.length > windowSize) cpsWindow.shift();
 const avgCPS = cpsWindow.reduce((a,b)=>a+b,0) / cpsWindow.length;
 const avgCPM = avgCPS * 60;

 doseWindow.push(u);
 if(doseWindow.length > windowSize) doseWindow.shift();
 const avgDose = doseWindow.reduce((a,b)=>a+b,0) / doseWindow.length;

 // live values
 document.getElementById("live_rate").textContent  = avgCPS.toFixed(1);
 document.getElementById("live_cpm").textContent   = Math.round(avgCPM);
 document.getElementById("live_usvh").textContent  = avgDose.toFixed(3);
 document.getElementById("live_mremh").textContent = (avgDose*100).toFixed(3);

 const p = Math.min(100, avgDose);
 const bar = document.getElementById("bar");
 bar.style.width = p+"%";
 bar.style.background = (p<50?"green":p<80?"gold":"red");

 document.getElementById("contextText").textContent =
   "Radiation level equal to: " + classify(avgDose);

 // log table row
 const r=document.createElement("tr");
 r.innerHTML=`<td>${elapsed}</td><td>${avgCPS.toFixed(1)}</td><td>${totalCounts}</td>`;
 document.getElementById("pulseTable").prepend(r);

 // push smoothed CPS into history
 cpsHistory.push(avgCPS);
 if(cpsHistory.length > 120) cpsHistory.shift(); // keep 2 minutes

 // redraw histogram
 drawCPSHistogram();

 intervalCounts = 0;
},1000);

/* Export */
document.getElementById("exportBtn").onclick=()=>{
 let rows=[["Time","CPS","Total"]];
 [...document.getElementById("pulseTable").rows].forEach(r=>{
  rows.push([r.cells[0].innerText,r.cells[1].innerText,r.cells[2].innerText]);
 });
 const blob=new Blob([rows.map(e=>e.join(",")).join("\n")],{type:"text/csv"});
 const a=document.createElement("a");
 a.href=URL.createObjectURL(blob);
 a.download="radiation_log.csv";
 a.click();
};
function drawCPSHistogram() {
  const canvas = document.getElementById("cpsCanvas");
  const ctx = canvas.getContext("2d");

  const styleWidth = canvas.clientWidth;
  const styleHeight = canvas.clientHeight;
  canvas.width = styleWidth;
  canvas.height = styleHeight;

  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // bar width ~2mm
  const pxPerMM = window.devicePixelRatio * 3.78;
  const barWidth = pxPerMM * 2;
  const maxBars = Math.floor(canvas.width / barWidth);

  const data = cpsHistory.slice(-maxBars);
  const maxCPS = Math.max(...data, 1);

  const scale = (canvas.height * 0.8) / maxCPS;

  ctx.fillStyle = "#2563eb";

  for (let i = 0; i < data.length; i++) {
    const value = data[i];
    const barHeight = value * scale;
    const x = i * barWidth;
    const y = canvas.height - barHeight;

    ctx.fillRect(x, y, barWidth - 1, barHeight);
  }
}


</script>
</body>
</html>
