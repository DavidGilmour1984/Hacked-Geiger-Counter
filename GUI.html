<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>GeigerLink</title>

<!-- Correct radiation trefoil favicon -->
<link rel="icon" href='data:image/svg+xml;utf8,
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200">
<circle cx="100" cy="100" r="95" fill="yellow" stroke="black" stroke-width="12"/>
<circle cx="100" cy="100" r="22" fill="black"/>
<path d="M100 35 L135 115 L65 115 Z" fill="black" transform="rotate(0 100 100)"/>
<path d="M100 35 L135 115 L65 115 Z" fill="black" transform="rotate(120 100 100)"/>
<path d="M100 35 L135 115 L65 115 Z" fill="black" transform="rotate(240 100 100)"/>
</svg>' />

<style>
body {
  font-family: Helvetica, Arial, sans-serif;
  background:#eef2f8;
  margin:0; padding:20px;
  color:#0d1117;
}
.row { display:flex; gap:20px; width:100%; margin-bottom:20px; }
.col { flex:1; display:flex; flex-direction:column; }
.card {
  background:white;
  padding:18px;
  border-radius:14px;
  box-shadow:0 3px 10px rgba(0,0,0,0.15);
}
.equal-card {
  height:360px;
  display:flex;
  flex-direction:column;
}
table { width:100%; border-collapse:collapse; font-size:17px; }
th { background:#f2f4f8; font-weight:600; }
td, th { padding:8px; border-bottom:1px solid #e3e3e3; }

/* Live table: labels left, values right */
.live-table td:first-child { text-align:left; }
.live-table td:last-child  { text-align:right; font-family:"Courier New", monospace; }

/* Log table: number alignment stable */
.log-table th, .log-table td { text-align:right; font-family:"Courier New", monospace; }

button {
  font-size:16px; padding:8px 14px;
  border:none; border-radius:8px;
  background:#2563eb; color:white; cursor:pointer;
  margin:4px;
}
button:hover { background:#1e40af; }

.scroll-box {
  max-height:350px;
  overflow-y:auto;
  border:1px solid #d0d0d0;
  border-radius:8px;
  margin-top:10px;
}

.range-bar {
  height:40px; width:100%; background:#ccc; border-radius:6px; overflow:hidden;
}
.fill {
  height:100%; width:0%; background:green;
  transition:width .25s, background-color .25s;
}
</style>
</head>

<body>
<h2>GeigerLink</h2>

<div class="row">

<!-- Controls -->
<div class="col">
<div class="card equal-card">
<h3>Controls</h3>
<button id="connectBtn">Connect</button>
<button id="startBtn">Start</button>
<button id="stopBtn">Stop</button>
<button id="exportBtn">Export CSV</button><br>
<button id="soundToggleBtn">Sound: OFF</button>
</div>
</div>

<!-- Live Data -->
<div class="col">
<div class="card equal-card">
<h3>Live Data</h3>
<table class="live-table">
<tr><td><b>ADC</b></td><td id="live_adc">0</td></tr>
<tr><td><b>Total Counts</b></td><td id="live_total">0</td></tr>
<tr><td><b>CPS</b></td><td id="live_rate">0.0</td></tr>
<tr><td><b>CPM</b></td><td id="live_cpm">0</td></tr>
<tr><td><b>ÂµSv/h</b></td><td id="live_usvh">0.000</td></tr>
<tr><td><b>mrem/h</b></td><td id="live_mremh">0.000</td></tr>
</table>
</div>
</div>

<!-- Logging -->
<div class="col">
<div class="card equal-card">
<h3>Logging</h3>
<div class="scroll-box">
<table class="log-table">
<thead><tr><th>Time</th><th>CPS</th><th>Total</th></tr></thead>
<tbody id="pulseTable"></tbody>
</table>
</div>
</div>
</div>

</div>

<!-- Dose bar -->
<div class="card" style="width:100%; margin-top:15px;">
<h3>Radiation Level</h3>
<div class="range-bar"><div id="bar" class="fill"></div></div>
<div id="contextText" style="font-size:18px; margin-top:8px; font-weight:600;">
Radiation level equal to: Normal Background
</div>
</div>

<script>
let port, reader, writer;
let decoder = new TextDecoderStream();
let running = false;
let startTime = 0;
let totalCounts = 0;
let intervalCounts = 0;
const uSvPerCPM = 0.0057;

/* rolling windows */
let cpsWindow = [];
let doseWindow = [];
const windowSize = 30; // last 10 seconds smoothing

/* thresholds */
const thresholds = [
{level:0.01, name:"Deep Underground Lab"},
{level:0.05, name:"Normal Background"},
{level:0.15, name:"NZ Background (typical)"},
{level:1, name:"High-background region"},
{level:3, name:"Commercial Flight"},
{level:6, name:"High-altitude city"},
{level:8, name:"Polar aviation route"},
{level:12, name:"Dental X-ray (hour)"},
{level:20, name:"Fukushima Perimeter"},
{level:30, name:"Radon Hotspot (UK)"},
{level:50, name:"Ramsar, Iran"},
{level:100, name:"Fukushima Worker Gate"}
];
function classify(u){
 for(let t of thresholds) if(u <= t.level) return t.name;
 return thresholds.at(-1).name;
}

/* Geiger click */
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
let clickEnabled = false;
function geigerClick(){
 if(!clickEnabled) return;
 const osc = audioCtx.createOscillator();
 const gain = audioCtx.createGain();
 osc.type = "square";
 osc.frequency.value = 4500;
 gain.gain.value = 0.10;
 osc.connect(gain);
 gain.connect(audioCtx.destination);
 osc.start();
 osc.stop(audioCtx.currentTime + 0.002);
}
document.getElementById("soundToggleBtn").onclick=()=>{
 clickEnabled = !clickEnabled;
 audioCtx.resume();
 document.getElementById("soundToggleBtn").textContent =
   clickEnabled ? "Sound: ON" : "Sound: OFF";
};

/* Serial reading */
async function readLoop(){
 while(true){
  const {value,done} = await reader.read();
  if(done) break;
  if(!value) continue;
  const x = parseInt(value.trim());
  if(!isNaN(x) && running){
    totalCounts++;
    intervalCounts++;
    geigerClick();
    document.getElementById("live_adc").textContent = x;
    document.getElementById("live_total").textContent = totalCounts;
  }
 }
}

/* Connect */
document.getElementById("connectBtn").onclick=async()=>{
 port = await navigator.serial.requestPort();
 await port.open({baudRate:115200});
 port.readable.pipeTo(decoder.writable);
 reader = decoder.readable.getReader();
 writer = port.writable.getWriter();
 readLoop();
};

/* Start */
document.getElementById("startBtn").onclick=()=>{
 running = true;
 totalCounts=0;
 intervalCounts=0;
 cpsWindow=[];
 doseWindow=[];
 startTime = performance.now();
 document.getElementById("pulseTable").innerHTML="";
};

/* Stop */
document.getElementById("stopBtn").onclick=()=> running=false;

/* Update each second */
setInterval(()=>{
 if(!running) return;

 const elapsed = Math.floor((performance.now()-startTime)/1000);
 const cps = intervalCounts;
 const cpm = cps * 60;
 const u = cpm * uSvPerCPM;

 cpsWindow.push(cps);
 if(cpsWindow.length > windowSize) cpsWindow.shift();
 const avgCPS = cpsWindow.reduce((a,b)=>a+b,0) / cpsWindow.length;
 const avgCPM = avgCPS * 60;

 doseWindow.push(u);
 if(doseWindow.length > windowSize) doseWindow.shift();
 const avgDose = doseWindow.reduce((a,b)=>a+b,0) / doseWindow.length;

 document.getElementById("live_rate").textContent  = avgCPS.toFixed(1);
 document.getElementById("live_cpm").textContent   = Math.round(avgCPM);
 document.getElementById("live_usvh").textContent  = avgDose.toFixed(3);
 document.getElementById("live_mremh").textContent = (avgDose*100).toFixed(3);

 const p = Math.min(100, avgDose);
 const bar = document.getElementById("bar");
 bar.style.width = p+"%";
 bar.style.background = (p<50?"green":p<80?"gold":"red");

 document.getElementById("contextText").textContent =
   "Radiation level equal to: " + classify(avgDose);

 const r=document.createElement("tr");
 r.innerHTML=`<td>${elapsed}</td><td>${avgCPS.toFixed(1)}</td><td>${totalCounts}</td>`;
 document.getElementById("pulseTable").prepend(r);

 intervalCounts = 0;
},1000);

/* Export */
document.getElementById("exportBtn").onclick=()=>{
 let rows=[["Time","CPS","Total"]];
 [...document.getElementById("pulseTable").rows].forEach(r=>{
  rows.push([r.cells[0].innerText,r.cells[1].innerText,r.cells[2].innerText]);
 });
 const blob=new Blob([rows.map(e=>e.join(",")).join("\n")],{type:"text/csv"});
 const a=document.createElement("a");
 a.href=URL.createObjectURL(blob);
 a.download="radiation_log.csv";
 a.click();
};
</script>
</body>
</html>
