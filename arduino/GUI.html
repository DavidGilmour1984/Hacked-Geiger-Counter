<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Geiger Counter Pulse Monitor</title>
<style>
body {
  font-family: Helvetica, Arial, sans-serif;
  background:#f5f7fb; color:#111;
  padding:20px; margin:0;
}
.card {
  background:white; padding:20px;
  border-radius:12px; max-width:600px;
  margin:auto; box-shadow:0 2px 6px rgba(0,0,0,0.15);
}
button {
  font-size:20px; background:#2563eb;
  color:white; padding:10px 20px;
  border:none; border-radius:8px;
  cursor:pointer;
}
button:hover { background:#1e40af; }
.data-box { font-size:26px; margin:10px 0; }
</style>
</head>
<body>

<div class="card">
<h2>Geiger Counter Pulse Monitor</h2>
<button id="connect">Connect</button>

<div class="data-box">Last Pulse Min ADC: <span id="adc">--</span></div>
<div class="data-box">CPM: <span id="cpm">0</span></div>
<div class="data-box">µSv/h: <span id="usvh">0.000</span></div>

<div style="margin-top:20px;font-size:20px;">
Threshold: <span id="thval">600</span>
<input type="range" id="thrSlider" min="100" max="1023" value="600" style="width:100%;">
</div>
</div>

<script>
let port, reader, writer;
let textDecoder = new TextDecoderStream();
let samples = [];
const conversionFactor = 0.0057; // µSv/h per CPM for SBM-20

async function connectSerial() {
  port = await navigator.serial.requestPort();
  await port.open({ baudRate: 115200 });

  // Setup reading
  port.readable.pipeTo(textDecoder.writable);
  reader = textDecoder.readable.getReader();

  // Setup writing
  writer = port.writable.getWriter();

  readLoop();
}

async function readLoop() {
  while (true) {
    const { value, done } = await reader.read();
    if (done) break;
    if (!value) continue;

    const line = value.trim();
    const v = parseInt(line);
    if (!isNaN(v)) handlePulse(v);
  }
}

function handlePulse(minValue) {
  document.getElementById("adc").textContent = minValue;

  const now = Date.now();
  samples.push(now);
  samples = samples.filter(t => now - t <= 60000);

  const CPM = samples.length;
  const uSvH = CPM * conversionFactor;

  document.getElementById("cpm").textContent = CPM;
  document.getElementById("usvh").textContent = uSvH.toFixed(3);
}

document.getElementById("thrSlider").addEventListener("input", async e => {
  const t = parseInt(e.target.value);
  document.getElementById("thval").textContent = t;
  if (writer) writer.write(new TextEncoder().encode("T" + t + "\n"));
});

document.getElementById("connect").addEventListener("click", connectSerial);
</script>

</body>
</html>
